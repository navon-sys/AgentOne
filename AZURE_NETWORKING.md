# 🌐 Azure VM Network Configuration Guide

## Understanding Azure Network Architecture

Your Azure VM has **TWO IP addresses**:

### 1. **Private IP: 10.0.0.4**
- Internal Azure Virtual Network (VNet) address
- Used for communication within Azure
- This is what Vite displays when showing "Network"
- **This is the actual network interface IP**

### 2. **Public IP: 20.82.140.166**
- External/Internet-facing IP address
- Mapped by Azure to your private IP via NAT (Network Address Translation)
- This is what users access from the internet
- **This is what you share with users**

---

## 🎯 How It Works

```
Internet User
    ↓
    → http://20.82.140.166:5173 (Public IP)
    ↓
Azure NAT/Load Balancer
    ↓
    → http://10.0.0.4:5173 (Private IP)
    ↓
Your VM (listening on 0.0.0.0:5173)
    ↓
Vite Dev Server
```

**Key Point:** When Vite shows `Network: http://10.0.0.4:5173`, this is **CORRECT**. 
Azure automatically forwards traffic from `20.82.140.166` to `10.0.0.4`.

---

## ✅ Verification That It's Working

### Test 1: From Your VM (Internal)
```bash
curl http://10.0.0.4:5173
curl http://localhost:5173
```
Both should work ✅

### Test 2: From Internet (External)
Open in browser on your local machine:
```
http://20.82.140.166:5173
```
Should show the application ✅

### Test 3: API Health Check
```bash
# From anywhere
curl http://20.82.140.166:3001/api/health
```
Should return: `{"status":"ok","services":{...}}` ✅

---

## 🚀 Starting the Application

### Option 1: Use Helper Scripts (Recommended)

```bash
# Terminal 1 - Backend
cd /home/azureuser/webapp
./start-backend.sh

# Terminal 2 - Frontend
cd /home/azureuser/webapp
./start-frontend.sh
```

The helper scripts will display the correct public IP URLs!

### Option 2: Manual Start

```bash
# Terminal 1 - Backend
cd /home/azureuser/webapp
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
npm run server

# Terminal 2 - Frontend
cd /home/azureuser/webapp
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
npm run dev
```

**Note:** Vite will show `Network: http://10.0.0.4:5173` - this is normal!
The public URL is: `http://20.82.140.166:5173`

---

## 📱 URLs to Share

### For HR Staff
```
Frontend: http://20.82.140.166:5173
```

### For Candidates
Unique links generated by the app:
```
http://20.82.140.166:5173?token=xxxxx
```

### API Endpoints (for developers)
```
Backend API:    http://20.82.140.166:3001
Health Check:   http://20.82.140.166:3001/api/health
```

---

## 🔧 Configuration Files

### vite.config.js
```javascript
export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    host: '0.0.0.0',  // ✅ Correct - listens on all interfaces
    strictPort: true
  }
})
```

**Why `0.0.0.0`?**
- Binds to ALL network interfaces
- Allows both localhost AND network access
- Essential for Azure VMs to accept external traffic

### server/index.js
```javascript
app.listen(PORT, '0.0.0.0', () => {
  console.log(`Backend running on http://20.82.140.166:${PORT}`)
})
```

---

## 🔍 Network Diagnostics

### Check What IPs Your VM Has
```bash
# All IP addresses
hostname -I

# Primary IP
hostname -I | awk '{print $1}'

# Detailed network info
ip addr show
```

### Check What Ports Are Listening
```bash
# Show all listening ports
sudo netstat -tuln | grep LISTEN

# Should show:
# 0.0.0.0:3001  ✅ Backend (all interfaces)
# 0.0.0.0:5173  ✅ Frontend (all interfaces)
```

### Check If Ports Are Accessible
```bash
# From VM (tests local binding)
curl http://localhost:5173
curl http://10.0.0.4:5173

# From external machine (tests public access)
curl http://20.82.140.166:5173
curl http://20.82.140.166:3001/api/health
```

---

## 🛡️ Azure Network Security Group (NSG)

Your NSG must have these inbound rules:

| Priority | Port | Protocol | Source | Destination | Name |
|----------|------|----------|--------|-------------|------|
| 100 | 5173 | TCP | Any | Any | AllowVite |
| 110 | 3001 | TCP | Any | Any | AllowAPI |
| 120 | 22 | TCP | Any | Any | AllowSSH |

**To verify/add:**
1. Azure Portal → Your VM → Networking
2. Check "Inbound port rules"
3. Add missing rules if needed

---

## 🐛 Troubleshooting

### Issue: "Vite shows 10.0.0.4 instead of 20.82.140.166"

**This is NORMAL!** ✅

- Vite displays the actual network interface IP (10.0.0.4)
- Azure NAT maps the public IP (20.82.140.166) to it
- Users access via public IP, it works automatically
- Use the helper scripts to see the correct URLs

### Issue: "Can't access from internet"

**Checklist:**
```bash
# 1. Is server listening on 0.0.0.0?
sudo netstat -tuln | grep 5173
# Should show: 0.0.0.0:5173

# 2. Is NSG allowing traffic?
# Check Azure Portal → Networking → Inbound rules

# 3. Is VM firewall allowing?
sudo ufw status
sudo ufw allow 5173/tcp

# 4. Test from VM
curl http://20.82.140.166:5173
```

### Issue: "Site loads but API calls fail"

**Check:**
```bash
# 1. Backend running?
curl http://20.82.140.166:3001/api/health

# 2. CORS configured?
# Check server/index.js has: app.use(cors())

# 3. Frontend using correct API URL?
# Check browser console (F12) → Network tab
```

### Issue: "Connection refused"

**Means:** Server not listening or firewall blocking

**Fix:**
```bash
# Restart servers
pkill -9 node
cd /home/azureuser/webapp
./start-backend.sh &
./start-frontend.sh &

# Check if listening
sudo netstat -tuln | grep -E '3001|5173'
```

---

## 📊 Complete Network Map

```
┌─────────────────────────────────────────────────────────────┐
│                    INTERNET USERS                           │
│                                                             │
│  Browser: http://20.82.140.166:5173                        │
│  API:     http://20.82.140.166:3001                        │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│              AZURE PUBLIC IP (NAT)                          │
│                                                             │
│  Public IP: 20.82.140.166                                   │
│  Maps to → 10.0.0.4 (Private IP)                           │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│           AZURE NETWORK SECURITY GROUP (NSG)                │
│                                                             │
│  Rule 1: Allow port 5173 (Frontend)                        │
│  Rule 2: Allow port 3001 (Backend)                         │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│              YOUR AZURE VM (10.0.0.4)                       │
│                                                             │
│  VM Firewall (UFW): Allow 5173, 3001                       │
│  Network Interface: eth0 (10.0.0.4)                        │
│                                                             │
│  ┌──────────────────┐      ┌──────────────────┐           │
│  │  Vite Dev Server │      │  Express API     │           │
│  │  Port: 5173      │      │  Port: 3001      │           │
│  │  Bind: 0.0.0.0   │      │  Bind: 0.0.0.0   │           │
│  └──────────────────┘      └──────────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

---

## 💡 Key Takeaways

1. **Private IP (10.0.0.4)** = Internal Azure network
2. **Public IP (20.82.140.166)** = Internet-facing address
3. **Vite showing 10.0.0.4 is CORRECT** - Azure handles the mapping
4. **Always share the PUBLIC IP** with users: `20.82.140.166`
5. **Server must bind to `0.0.0.0`** to accept all traffic
6. **NSG rules must allow ports** 5173 and 3001

---

## ✅ Quick Reference

| What | Private (VNet) | Public (Internet) |
|------|----------------|-------------------|
| Frontend | http://10.0.0.4:5173 | http://20.82.140.166:5173 |
| Backend | http://10.0.0.4:3001 | http://20.82.140.166:3001 |
| Health | http://10.0.0.4:3001/api/health | http://20.82.140.166:3001/api/health |

**Share with users:** Public URLs only!

---

## 🎓 Additional Resources

- [Azure Virtual Network](https://docs.microsoft.com/azure/virtual-network/)
- [Azure Public IP](https://docs.microsoft.com/azure/virtual-network/public-ip-addresses)
- [Network Security Groups](https://docs.microsoft.com/azure/virtual-network/network-security-groups-overview)

---

**Last Updated:** Configured for Azure VM with private IP 10.0.0.4 and public IP 20.82.140.166

---

## 🆘 Still Having Issues?

Run the diagnostic script:

```bash
cd /home/azureuser/webapp
cat > network-test.sh << 'EOF'
#!/bin/bash
echo "=== Network Diagnostic Test ==="
echo ""
echo "1. Private IP:"
hostname -I | awk '{print $1}'
echo ""
echo "2. Listening Ports:"
sudo netstat -tuln | grep -E '3001|5173'
echo ""
echo "3. Local Test (Frontend):"
curl -s -I http://localhost:5173 | head -1
echo ""
echo "4. Local Test (Backend):"
curl -s http://localhost:3001/api/health
echo ""
echo "5. Public Test (Frontend):"
curl -s -I http://20.82.140.166:5173 | head -1
echo ""
echo "6. Public Test (Backend):"
curl -s http://20.82.140.166:3001/api/health
echo ""
echo "7. Firewall Status:"
sudo ufw status
echo ""
echo "=== End Diagnostic ==="
EOF
chmod +x network-test.sh
./network-test.sh
```

This will help identify the exact issue! 🔍
